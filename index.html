<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IndexedDB and Firebase Integration</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      width: 300px;
    }
    .container h2 {
      text-align: center;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      background-color: #28a745;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #218838;
    }
    .result {
      margin-top: 20px;
      padding: 10px;
      background-color: #e9ecef;
      border-radius: 4px;
    }
  
  </style>
</head>
<body>
  <div class="container">
    <h2>Customer Manager</h2>
    <label for="customerId">ID</label>
    <input type="number" id="customerId" placeholder="Enter Customer ID" required>
    
    <label for="customerName">Name</label>
    <input type="text" id="customerName" placeholder="Enter Customer Name" required>
    
    <label for="customerEmail">Email</label>
    <input type="text" id="customerEmail" placeholder="Enter Customer Email" required>
    
    <button onclick="addCustomer()">Add Customer</button>
    <button onclick="getCustomer()">Get Customer</button>
    <button onclick="updateCustomer()">Update Customer</button>
    
    <div id="result" class="result"></div>
  </div>

 <script type="module">
  
   // Import Firebase modules directly from Firebase CDN
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
  import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js";

    // Firebase configuration (replace with your Firebase project details)
	const firebaseConfig = {
	  apiKey: "AIzaSyC2UiNhd20V9lKTGXT4gl7uB2NTK-ZvyNw",
	  authDomain: "myproject9090-444fc.firebaseapp.com",
	  databaseURL: "https://myproject9090-444fc-default-rtdb.firebaseio.com",
	  projectId: "myproject9090-444fc",
	  storageBucket: "myproject9090-444fc.appspot.com",
	  messagingSenderId: "314456664907",
	  appId: "1:314456664907:web:ea39627889c7e65f2f16ce",
	  measurementId: "G-HPZG0CKD9E"
	};

	// Initialize Firebase
	const app = initializeApp(firebaseConfig);
	const database = getDatabase(app);
    // IndexedDB setup
    let db;
    let request = indexedDB.open("MyDatabase", 1);

    request.onupgradeneeded = (event) => {
      db = event.target.result;
      let objectStore = db.createObjectStore("customers", { keyPath: "id" });
      objectStore.createIndex("name", "name", { unique: false });
      objectStore.createIndex("email", "email", { unique: true });
    };

    request.onsuccess = (event) => {
      db = event.target.result;
    };

    request.onerror = (event) => {
      console.error("Database error:", event.target.error);
    };	
	
  // Functions to interact with Firebase Database
  window.addCustomer = function addCustomer() {
    const id = parseInt(document.getElementById("customerId").value);
    const name = document.getElementById("customerName").value;
    const email = document.getElementById("customerEmail").value;
    const customerRef = ref(database, "customers/" + id);

    set(customerRef, { id, name, email })
      .then(() => {
        document.getElementById("result").innerText = "Customer added to Firebase!";
      })
      .catch((error) => {
        console.error("Failed to add to Firebase:", error);
      });
  };

    // Function to get customer data
  window.getCustomer = async function getCustomer() {
    const id = parseInt(document.getElementById("customerId").value);
    const resultElement = document.getElementById("result");

    try {
      // Try to fetch from Firebase first
      const customerRef = ref(database, `customers/${id}`);
      const snapshot = await get(customerRef);

      if (snapshot.exists()) {
        const customer = snapshot.val();
        resultElement.innerText = `Found : ${customer.name}, ${customer.email}`;
      } else {
        resultElement.innerText = "Not found in Firebase, checking local storage...";

        // Fallback to IndexedDB if not found in Firebase
        let transaction = db.transaction(["customers"], "readonly");
        let objectStore = transaction.objectStore("customers");
        let request = objectStore.get(id);

        request.onsuccess = () => {
          const customer = request.result;
          if (customer) {
            resultElement.innerText = `Found in IndexedDB: ${customer.name}, ${customer.email}`;
          } else {
            resultElement.innerText = "Customer not found locally.";
          }
        };
      }
    } catch (error) {
      console.error("Error fetching from Firebase:", error);
      resultElement.innerText = "Error accessing Firebase, checking local storage...";
    }
  };

    // Function to update customer data
  window.updateCustomer = async function updateCustomer() {
    const id = parseInt(document.getElementById("customerId").value);
    const name = document.getElementById("customerName").value;
    const email = document.getElementById("customerEmail").value;
    const customer = { id, name, email };

    try {
      // Update in Firebase
      const customerRef = ref(database, `customers/${id}`);
      await set(customerRef, customer);
      document.getElementById("result").innerText = "Customer updated in Firebase!";
    } catch (error) {
      console.error("Firebase update failed:", error);
      document.getElementById("result").innerText = "Failed to update in Firebase, updating locally...";

      // Fallback to IndexedDB if Firebase update fails
      let transaction = db.transaction(["customers"], "readwrite");
      let objectStore = transaction.objectStore("customers");
      objectStore.put(customer);
      transaction.oncomplete = () => {
        document.getElementById("result").innerText = "Customer updated in IndexedDB!";
      };
      transaction.onerror = (event) => {
        console.error("IndexedDB update failed:", event.target.error);
      };
    }
  };
  </script>
</body>
</html>
